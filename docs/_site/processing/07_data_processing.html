<!DOCTYPE html>
<html lang="en">
  

  <head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width,minimum-scale=1">

  <title>Geoprocessing spatial data</title>
  <meta name="description" content="Spatial Data Processing with libpysal,  Pandas and Geopandas">

  <link rel="canonical" href="/YOUR%20URL//processing/07_data_processing.html">
  <link rel="alternate" type="application/rss+xml" title="Spatial Data Analysis with PySAL @NARSC2018" href="/YOUR%20URL//feed.xml">

  <meta property="og:url"         content="/YOUR%20URL//processing/07_data_processing.html" />
<meta property="og:type"        content="article" />
<meta property="og:title"       content="Geoprocessing spatial data" />
<meta property="og:description" content="Spatial Data Processing with libpysal,  Pandas and Geopandas" />
<meta property="og:image"       content="" />


  <script type="application/ld+json">
  {
  "@context": "http://schema.org",
  "@type": "NewsArticle",
  "mainEntityOfPage":
    "YOUR URL//processing/07_data_processing.html",
  "headline":
    "Geoprocessing spatial data",
  "datePublished":
    "2019-07-14T14:01:36-05:00",
  "dateModified":
    "2019-07-14T14:01:36-05:00",
  "description":
    "Spatial Data Processing with libpysal,  Pandas and Geopandas",
  "author": {
    "@type": "Person",
    "name": "Sergio Rey and Wei Kang"
  },
  "publisher": {
    "@type": "Organization",
    "name": "Data 100 at UC Berkeley",
    "logo": {
      "@type": "ImageObject",
      "url": "YOUR URL/",
      "width": 60,
      "height": 60
    }
  },
  "image": {
    "@type": "ImageObject",
    "url": "YOUR URL/",
    "height": 60,
    "width": 60
  }
}

  </script>
  <link rel="stylesheet" href="/assets/css/styles.css">
  <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css ">
  <link rel="apple-touch-icon" sizes="57x57" href="/apple-touch-icon-57x57.png">
  <link rel="apple-touch-icon" sizes="60x60" href="/apple-touch-icon-60x60.png">
  <link rel="apple-touch-icon" sizes="72x72" href="/apple-touch-icon-72x72.png">
  <link rel="apple-touch-icon" sizes="76x76" href="/apple-touch-icon-76x76.png">
  <link rel="apple-touch-icon" sizes="114x114" href="/apple-touch-icon-114x114.png">
  <link rel="apple-touch-icon" sizes="120x120" href="/apple-touch-icon-120x120.png">
  <link rel="apple-touch-icon" sizes="144x144" href="/apple-touch-icon-144x144.png">
  <link rel="apple-touch-icon" sizes="152x152" href="/apple-touch-icon-152x152.png">
  <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon-180x180.png">

  <!-- <link rel="manifest" href="/manifest.json"> -->
  <!-- <link rel="mask-icon" href="/safari-pinned-tab.svg" color="#efae0a"> -->
  <meta name="msapplication-TileColor" content="#da532c">
  <meta name="msapplication-TileImage" content="/mstile-144x144.png">
  <meta name="theme-color" content="#233947">

  <!-- Favicon -->
  <link rel="shortcut icon" type="image/x-icon" href="/images/logo/favicon.ico">

  <!-- MathJax Config -->
  <!-- Allow inline math using $ and automatically break long math lines -->
<script type="text/x-mathjax-config">
MathJax.Hub.Config({
    tex2jax: {
        inlineMath: [ ['$','$'], ["\\(","\\)"] ],
        displayMath: [ ['$$','$$'], ["\\[","\\]"] ],
        processEscapes: true,
        processEnvironments: true
    },
    CommonHTML: {
        linebreaks: {
            automatic: true,
        },
    },
});
</script>
<script src='https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-AMS_CHTML' async></script>

  <!-- DOM updating function -->
  <script>
const runWhenDOMLoaded = cb => {
  if (document.readyState != 'loading') {
    cb()
  } else if (document.addEventListener) {
    document.addEventListener('DOMContentLoaded', cb)
  } else {
    document.attachEvent('onreadystatechange', function() {
      if (document.readyState == 'complete') cb()
    })
  }
}

// Helper function to init things quickly
initFunction = function(myfunc) {
  runWhenDOMLoaded(myfunc);
  document.addEventListener('turbolinks:load', myfunc);
};
</script>

  <!-- Define some javascript variables that will be useful in other javascript -->
  <script>
    const site_basename = '/';
  </script>

  <!-- Add AnchorJS to let headers be linked -->
  <script src="/assets/js/anchor.min.js"  type="text/javascript"></script>
  <script>

initFunction(function () {
    anchors.add("main h1, main h2, main h3, main h4")
});

</script>

  <!-- Include Turbolinks to make page loads fast -->
  <!-- https://github.com/turbolinks/turbolinks -->
  <script src="/assets/js/turbolinks.js" async></script>
  <meta name="turbolinks-cache-control" content="no-cache">

  <!-- Load nbinteract for widgets -->
  

  <!-- Load Thebelab for interactive widgets -->
  <!-- Include Thebelab for interactive code if it's enabled -->


<!-- Display Thebelab button in each code cell -->
<script>
/**
 * Set up thebelab button for code blocks
 */

const thebelabCellButton = id =>
  `<a id="thebelab-cell-button-${id}" class="btn thebebtn o-tooltip--left" data-tooltip="Interactive Mode">
    <img src="/assets/images/edit-button.svg" alt="Start interactive mode">
  </a>`


const addThebelabButtonToCodeCells =  () => {

  const codeCells = document.querySelectorAll('div.input_area > div.highlighter-rouge:not(.output) pre')
  codeCells.forEach((codeCell, index) => {
    const id = codeCellId(index)
    codeCell.setAttribute('id', id)
    if (document.getElementById("thebelab-cell-button-" + id) == null) {
      codeCell.insertAdjacentHTML('afterend', thebelabCellButton(id));
    }
  })
}

initFunction(addThebelabButtonToCodeCells);
</script>



<script type="text/x-thebe-config">
    {
      requestKernel: true,
      binderOptions: {
        repo: 'YOUR-ORG/YOUR-REPO',
        ref: 'gh-pages',
      },
      codeMirrorConfig: {
        theme: "abcdef"
      },
      kernelOptions: {
        name: 'python3',
      }
    }
</script>
<script src="https://unpkg.com/thebelab@0.4.0/lib/index.js"></script>
<script>
    /**
     * Add attributes to Thebelab blocks
     */

    const initThebelab = () => {
        const addThebelabToCodeCells = () => {
            console.log("Adding thebelab to code cells...");
            // If Thebelab hasn't loaded, wait a bit and try again. This
            // happens because we load ClipboardJS asynchronously.
            if (window.thebelab === undefined) {
                setTimeout(addThebelabToCodeCells, 250)
            return
            }

            // If we already detect a Thebelab cell, don't re-run
            if (document.querySelectorAll('div.thebelab-cell').length > 0) {
                return;
            }

            // Find all code cells, replace with Thebelab interactive code cells
            const codeCells = document.querySelectorAll('.input_area pre')
            codeCells.forEach((codeCell, index) => {
                const id = codeCellId(index)
                codeCell.setAttribute('data-executable', 'true')

                // Figure out the language it uses and add this too
                var parentDiv = codeCell.parentElement.parentElement;
                var arrayLength = parentDiv.classList.length;
                for (var ii = 0; ii < arrayLength; ii++) {
                    var parts = parentDiv.classList[ii].split('language-');
                    if (parts.length === 2) {
                        // If found, assign dataLanguage and break the loop
                        var dataLanguage = parts[1];
                        break;
                    }
                }
                codeCell.setAttribute('data-language', dataLanguage)

                // If the code cell is hidden, show it
                var inputCheckbox = document.querySelector(`input#hidebtn${codeCell.id}`);
                if (inputCheckbox !== null) {
                    setCodeCellVisibility(inputCheckbox, 'visible');
                }
            });

            // Remove the event listener from the page so keyboard press doesn't
            // Change page
            document.removeEventListener('keydown', initPageNav)
            keyboardListener = false;

            // Init thebelab
            thebelab.bootstrap();

            // Remove copy buttons since they won't work anymore
            const copyAndThebeButtons = document.querySelectorAll('.copybtn, .thebebtn')
            copyAndThebeButtons.forEach((button, index) => {
                button.remove();
            });

            // Remove outputs since they'll be stale
            const outputs = document.querySelectorAll('.output *, .output')
            outputs.forEach((output, index) => {
                output.remove();
            });
        }

        // Add event listener for the function to modify code cells
        const thebelabButtons = document.querySelectorAll('[id^=thebelab], [id$=thebelab]')
        thebelabButtons.forEach((thebelabButton,index) => {
            if (thebelabButton === null) {
                setTimeout(initThebelab, 250)
                return
            };
            thebelabButton.addEventListener('click', addThebelabToCodeCells);
        });
    }

    // Initialize Thebelab
    initFunction(initThebelab);
</script>



  <!-- Load the auto-generating TOC -->
  <script src="/assets/js/tocbot.min.js"  type="text/javascript"></script>
  <script>
var initToc = function () {
  tocbot.init({
    tocSelector: 'nav.onthispage',
    contentSelector: '.c-textbook__content',
    headingSelector: 'h2, h3',
    orderedList: false,
    collapseDepth: 6,
    listClass: 'toc__menu',
    activeListItemClass: "",  // Not using
    activeLinkClass: "", // Not using
  });
  tocbot.refresh();
}
initFunction(initToc);
</script>

  <!-- Google analytics -->
  <script src="/assets/js/ga.js" async></script>

  <!-- Clipboard copy button -->
  <script src="https://cdn.jsdelivr.net/npm/clipboard@2/dist/clipboard.min.js" async></script>

  <!-- Load JS that depends on site variables -->
  <script>
/**
 * Set up copy/paste for code blocks
 */
const codeCellId = index => `codecell${index}`

const clipboardButton = id =>
  `<a id="copy-button-${id}" class="btn copybtn o-tooltip--left" data-tooltip="Copy" data-clipboard-target="#${id}">
    <img src="/assets/images/copy-button.svg" alt="Copy to clipboard">
  </a>`

// Clears selected text since ClipboardJS will select the text when copying
const clearSelection = () => {
  if (window.getSelection) {
    window.getSelection().removeAllRanges()
  } else if (document.selection) {
    document.selection.empty()
  }
}

// Changes tooltip text for two seconds, then changes it back
const temporarilyChangeTooltip = (el, newText) => {
  const oldText = el.getAttribute('data-tooltip')
  el.setAttribute('data-tooltip', newText)
  setTimeout(() => el.setAttribute('data-tooltip', oldText), 2000)
}

const addCopyButtonToCodeCells = () => {
  // If ClipboardJS hasn't loaded, wait a bit and try again. This
  // happens because we load ClipboardJS asynchronously.
  if (window.ClipboardJS === undefined) {
    setTimeout(addCopyButtonToCodeCells, 250)
    return
  }

  const codeCells = document.querySelectorAll('div.c-textbook__content > div.highlighter-rouge > div.highlight > pre, div.input_area pre')
  codeCells.forEach((codeCell, index) => {
    const id = codeCellId(index)
    codeCell.setAttribute('id', id)
    if (document.getElementById("copy-button" + id) == null) {
      codeCell.insertAdjacentHTML('afterend', clipboardButton(id));
    }
  })

  const clipboard = new ClipboardJS('.copybtn')
  clipboard.on('success', event => {
    clearSelection()
    temporarilyChangeTooltip(event.trigger, 'Copied!')
  })

  clipboard.on('error', event => {
    temporarilyChangeTooltip(event.trigger, 'Failed to copy')
  })

  // Get rid of clipboard before the next page visit to avoid memory leak
  document.addEventListener('turbolinks:before-visit', () =>
    clipboard.destroy()
  )
}

initFunction(addCopyButtonToCodeCells);
</script>


  <!-- Hide cell code -->
  <script>
    /**
    Add buttons to hide code cells
    */


    var setCodeCellVisibility = function (inputField, kind) {
        // Update the image and class for hidden
        var id = inputField.getAttribute('data-id');
        var codeCell = document.querySelector(`#${id} div.highlight`);

        if (kind === "visible") {
            codeCell.classList.remove('hidden');
            inputField.checked = true;
        } else {
            codeCell.classList.add('hidden');
            inputField.checked = false;
        }
    }

    var toggleCodeCellVisibility = function (event) {
        // The label is clicked, and now we decide what to do based on the input field's clicked status
        if (event.target.tagName === "LABEL") {
            var inputField = event.target.previousElementSibling;
        } else {
            // It is the span inside the target
            var inputField = event.target.parentElement.previousElementSibling;
        }

        if (inputField.checked === true) {
            setCodeCellVisibility(inputField, "visible");
        } else {
            setCodeCellVisibility(inputField, "hidden");
        }
    }


    // Button constructor
    const hideCodeButton = id => `<input class="hidebtn" type="checkbox" id="hidebtn${id}" data-id="${id}"><label title="Toggle cell" for="hidebtn${id}" class="plusminus"><span class="pm_h"></span><span class="pm_v"></span></label>`

    var addHideButton = function () {
        // If a hide button is already added, don't add another
        if (document.querySelector('div.hidecode input') !== null) {
            return;
        }

        // Find the input cells and add a hide button
        document.querySelectorAll('div.input_area').forEach(function (item, index) {
            if (!item.classList.contains("hidecode")) {
                // Skip the cell if it doesn't have a hidecode class
                return;
            }

            const id = codeCellId(index)
            item.setAttribute('id', id);
            // Insert the button just inside the end of the next div
            item.querySelector('div').insertAdjacentHTML('beforeend', hideCodeButton(id))

            // Set up the visibility toggle
            hideLink = document.querySelector(`#${id} div.highlight + input + label`);
            hideLink.addEventListener('click', toggleCodeCellVisibility)
        });
    }


    // Initialize the hide buttos
    var initHiddenCells = function () {
        // Add hide buttons to the cells
        addHideButton();

        // Toggle the code cells that should be hidden
        document.querySelectorAll('div.hidecode input').forEach(function (item) {
            setCodeCellVisibility(item, 'hidden');
            item.checked = true;
        })
    }

    initFunction(initHiddenCells);

</script>

  <!-- Load custom website scripts -->
  <script src="/assets/js/scripts.js" async></script>

  <!-- Load custom user CSS and JS  -->
  <script src="/assets/custom/custom.js" async></script>
  <link rel="stylesheet" href="/assets/custom/custom.css">

  <!-- Update interact links w/ REST param, is defined in includes so we can use templates -->
  

  <!-- Lunr search code - will only be executed on the /search page -->
  <script src="/assets/js/lunr/lunr.min.js" type="text/javascript"></script>
  <script>var initQuery = function() {
  // See if we have a search box
  var searchInput = document.querySelector('input#lunr_search');
  if (searchInput === null) {
    return;
  }

  // Function to parse our lunr cache
  var idx = lunr(function () {
    this.field('title')
    this.field('excerpt')
    this.field('categories')
    this.field('tags')
    this.ref('id')

    this.pipeline.remove(lunr.trimmer)

    for (var item in store) {
      this.add({
        title: store[item].title,
        excerpt: store[item].excerpt,
        categories: store[item].categories,
        tags: store[item].tags,
        id: item
      })
    }
  });

  // Run search upon keyup
  searchInput.addEventListener('keyup', function () {
    var resultdiv = document.querySelector('#results');
    var query = document.querySelector("input#lunr_search").value.toLowerCase();
    var result =
      idx.query(function (q) {
        query.split(lunr.tokenizer.separator).forEach(function (term) {
          q.term(term, { boost: 100 })
          if(query.lastIndexOf(" ") != query.length-1){
            q.term(term, {  usePipeline: false, wildcard: lunr.Query.wildcard.TRAILING, boost: 10 })
          }
          if (term != ""){
            q.term(term, {  usePipeline: false, editDistance: 1, boost: 1 })
          }
        })
      });

      // Empty the results div
      while (resultdiv.firstChild) {
        resultdiv.removeChild(resultdiv.firstChild);
      }

    resultdiv.insertAdjacentHTML('afterbegin', '<p class="results__found">'+result.length+' Result(s) found</p>');
    for (var item in result) {
      var ref = result[item].ref;
      if(store[ref].teaser){
        var searchitem =
          '<div class="list__item">'+
            '<article class="archive__item" itemscope itemtype="https://schema.org/CreativeWork">'+
              '<h2 class="archive__item-title" itemprop="headline">'+
                '<a href="'+store[ref].url+'" rel="permalink">'+store[ref].title+'</a>'+
              '</h2>'+
              '<div class="archive__item-teaser">'+
                '<img src="'+store[ref].teaser+'" alt="">'+
              '</div>'+
              '<p class="archive__item-excerpt" itemprop="description">'+store[ref].excerpt.split(" ").splice(0,20).join(" ")+'...</p>'+
            '</article>'+
          '</div>';
      }
      else{
    	  var searchitem =
          '<div class="list__item">'+
            '<article class="archive__item" itemscope itemtype="https://schema.org/CreativeWork">'+
              '<h2 class="archive__item-title" itemprop="headline">'+
                '<a href="'+store[ref].url+'" rel="permalink">'+store[ref].title+'</a>'+
              '</h2>'+
              '<p class="archive__item-excerpt" itemprop="description">'+store[ref].excerpt.split(" ").splice(0,20).join(" ")+'...</p>'+
            '</article>'+
          '</div>';
      }
      resultdiv.insertAdjacentHTML('beforeend', searchitem);
    }
  });
};

initFunction(initQuery);
</script>
</head>

  <body>
    <!-- .js-show-sidebar shows sidebar by default -->
    <div id="js-textbook" class="c-textbook js-show-sidebar">
      



<nav id="js-sidebar" class="c-textbook__sidebar">
  <a href="https://jupyter.org/jupyter-book/"><img src="/images/logo/logo.png" class="textbook_logo" id="sidebar-logo" data-turbolinks-permanent/></a>
  <h2 class="c-sidebar__title">Spatial Data Analysis with PySAL @NARSC2018</h2>
  <ul class="c-sidebar__chapters">
    
      
      

      
      

      
      
      <li class="c-sidebar__chapter">
        <a class="c-sidebar__entry "
          href="/intro.html"
        >
          
          Home
        </a>

        
      </li>

      
    
      
      

      
      

      
      
      <li class="c-sidebar__chapter">
        <a class="c-sidebar__entry "
          href="https://github.com/sjsrey/pysalnarsc18"
        >
          
          GitHub repository
        </a>

        
      </li>

      
    
      
      
        <li class="c-sidebar__chapter"><a class="c-sidebar__entry" href="/search.html">Search</a></li>
        
      
      
        <li class="c-sidebar__divider"></li>
        
      
      
        <li><h2 class="c-sidebar__title">Content</li>
        
      
      

      
      

      
      
      <li class="c-sidebar__chapter">
        <a class="c-sidebar__entry "
          href="/primer/intro.html"
        >
          
            1.
          
          Python Primer
        </a>

        

          
          
          
          

          

          <ul class="c-sidebar__sections u-hidden-visually">
            
              
              

              <li class="c-sidebar__section">
                <a class="c-sidebar__entry "
                  href="/primer/00_notebook_intro.html"
                >
                  
                    1.1
                  
                  Jupyter Notebooks
                </a>

                
                

              </li>
              
            
              
              

              <li class="c-sidebar__section">
                <a class="c-sidebar__entry "
                  href="/primer/01_strings.html"
                >
                  
                    1.2
                  
                  Strings
                </a>

                
                

              </li>
              
            
              
              

              <li class="c-sidebar__section">
                <a class="c-sidebar__entry "
                  href="/primer/02_sequences.html"
                >
                  
                    1.3
                  
                  Sequences
                </a>

                
                

              </li>
              
            
              
              

              <li class="c-sidebar__section">
                <a class="c-sidebar__entry "
                  href="/primer/03_dictionaries.html"
                >
                  
                    1.4
                  
                  Dictionaries
                </a>

                
                

              </li>
              
            
              
              

              <li class="c-sidebar__section">
                <a class="c-sidebar__entry "
                  href="/primer/04_conditionals.html"
                >
                  
                    1.5
                  
                  Conditionals
                </a>

                
                

              </li>
              
            
          </ul>
        
      </li>

      
    
      
      

      
      

      
      
      <li class="c-sidebar__chapter">
        <a class="c-sidebar__entry "
          href="/processing/intro.html"
        >
          
            2.
          
          Geoprocessing and Visualization
        </a>

        

          
          
          
          

          

          <ul class="c-sidebar__sections ">
            
              
              

              <li class="c-sidebar__section">
                <a class="c-sidebar__entry c-sidebar__entry--active"
                  href="/processing/07_data_processing.html"
                >
                  
                    2.1
                  
                  Geoprocessing spatial data
                </a>

                
                

              </li>
              
            
              
              

              <li class="c-sidebar__section">
                <a class="c-sidebar__entry "
                  href="/processing/08_routes.html"
                >
                  
                    2.2
                  
                  Geoprocessing Exercise
                </a>

                
                

              </li>
              
            
              
              

              <li class="c-sidebar__section">
                <a class="c-sidebar__entry "
                  href="/processing/09_geovisualization.html"
                >
                  
                    2.3
                  
                  Geovisualization
                </a>

                
                

              </li>
              
            
          </ul>
        
      </li>

      
    
      
      

      
      

      
      
      <li class="c-sidebar__chapter">
        <a class="c-sidebar__entry "
          href="/esda/intro.html"
        >
          
            3.
          
          Exploratory Spatial Data Analysis
        </a>

        

          
          
          
          

          

          <ul class="c-sidebar__sections u-hidden-visually">
            
              
              

              <li class="c-sidebar__section">
                <a class="c-sidebar__entry "
                  href="/esda/13_global_texas.html"
                >
                  
                    3.1
                  
                  Global Spatial Autocorrelation
                </a>

                
                

              </li>
              
            
              
              

              <li class="c-sidebar__section">
                <a class="c-sidebar__entry "
                  href="/esda/12_sp_corr.html"
                >
                  
                    3.2
                  
                  Interactive Spatial Autocorrelation
                </a>

                
                

              </li>
              
            
              
              

              <li class="c-sidebar__section">
                <a class="c-sidebar__entry "
                  href="/esda/14_local_texas.html"
                >
                  
                    3.3
                  
                  Local Autocorrelation Analysis
                </a>

                
                

              </li>
              
            
              
              

              <li class="c-sidebar__section">
                <a class="c-sidebar__entry "
                  href="/esda/16_spatial_dynamics_analytics.html"
                >
                  
                    3.4
                  
                  Spatial Dynamics Analytics
                </a>

                
                

              </li>
              
            
              
              

              <li class="c-sidebar__section">
                <a class="c-sidebar__entry "
                  href="/esda/17_spatial_dynamics_visualization.html"
                >
                  
                    3.5
                  
                  Spatial Dynamics Visualization
                </a>

                
                

              </li>
              
            
          </ul>
        
      </li>

      
    
  </ul>
  <p class="sidebar_footer">Powered by <a href="https://github.com/jupyter/jupyter-book">Jupyter Book</a></p>
</nav>

      
      <!-- Empty sidebar placeholder that we'll auto-fill with javascript -->
      <aside class="sidebar__right">
          <header><h4 class="nav__title"><i class="fa fa-list"></i>   On this page</h4></header>
          <nav class="onthispage">
          </nav>
      </aside>
      
      <main class="c-textbook__page" tabindex="-1">
          <div class="o-wrapper">
            <div class="c-sidebar-toggle">
  <!-- We show the sidebar by default so we use .is-active -->
  <button
    id="js-sidebar-toggle"
    class="hamburger hamburger--arrowalt is-active"
  >
    <span class="hamburger-box">
      <span class="hamburger-inner"></span>
    </span>
    <span class="c-sidebar-toggle__label">Toggle Sidebar</span>
  </button>
</div>

            
<div class="buttons">
<a href="/content/processing/07_data_processing.ipynb" download>
<button id="interact-button-download" class="interact-button">Download</button>
</a>

<button id="interact-button-thebelab" class="interact-button">Thebelab</button>





</div>


            <div class="c-textbook__content">
              <h1 id="spatial-data-processing-with-libpysal--pandas-and-geopandas">Spatial Data Processing with libpysal,  Pandas and Geopandas</h1>

<div class="cell code_cell">
  <div class="input_area">
    <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># By convention, we use these shorter names</span>
<span class="kn">import</span> <span class="nn">libpysal</span> <span class="k">as</span> <span class="n">ps</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="n">pd</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="n">np</span>
<span class="kn">import</span> <span class="nn">geopandas</span> <span class="k">as</span> <span class="n">gpd</span>

</code></pre></div>    </div>
  </div>

</div>

<h2 id="libpysal">libpysal</h2>

<p>libpysal has a command that it uses to get the paths of its example datasets. Let’s work with a commonly-used dataset first.</p>

<div class="cell code_cell">
  <div class="input_area">
    <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">ps</span><span class="o">.</span><span class="n">examples</span><span class="o">.</span><span class="n">available</span><span class="p">()</span>

</code></pre></div>    </div>
  </div>

</div>

<div class="cell code_cell">
  <div class="input_area">
    <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">ps</span><span class="o">.</span><span class="n">examples</span><span class="o">.</span><span class="n">explain</span><span class="p">(</span><span class="s">'us_income'</span><span class="p">)</span>

</code></pre></div>    </div>
  </div>

</div>

<div class="cell code_cell">
  <div class="input_area">
    <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">csv_path</span> <span class="o">=</span> <span class="n">ps</span><span class="o">.</span><span class="n">examples</span><span class="o">.</span><span class="n">get_path</span><span class="p">(</span><span class="s">'usjoin.csv'</span><span class="p">)</span>
<span class="n">csv_path</span>

</code></pre></div>    </div>
  </div>

</div>

<div class="cell code_cell">
  <div class="input_area">
    <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">f</span> <span class="o">=</span> <span class="n">ps</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="nb">open</span><span class="p">(</span><span class="n">csv_path</span><span class="p">)</span>
<span class="n">f</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">10</span><span class="p">]</span>

</code></pre></div>    </div>
  </div>

</div>

<div class="cell code_cell">
  <div class="input_area">
    <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">y2009</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">by_col</span><span class="p">(</span><span class="s">'2009'</span><span class="p">)</span>

</code></pre></div>    </div>
  </div>

</div>

<div class="cell code_cell">
  <div class="input_area">
    <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">y2009</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">10</span><span class="p">]</span>

</code></pre></div>    </div>
  </div>

</div>

<h3 id="working-with-shapefiles">Working with shapefiles</h3>

<p>We can also work with local files outside the built-in examples.</p>

<p>To read in a shapefile, we will need the path to the file.</p>

<div class="cell code_cell">
  <div class="input_area">
    <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">shp_path</span> <span class="o">=</span> <span class="s">'data/texas.shp'</span>
<span class="k">print</span><span class="p">(</span><span class="n">shp_path</span><span class="p">)</span>

</code></pre></div>    </div>
  </div>

</div>

<p>Then, we open the file using the <code class="highlighter-rouge">ps.io.open</code> command:</p>

<div class="cell code_cell">
  <div class="input_area">
    <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">f</span> <span class="o">=</span> <span class="n">ps</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="nb">open</span><span class="p">(</span><span class="n">shp_path</span><span class="p">)</span>

</code></pre></div>    </div>
  </div>

</div>

<p><code class="highlighter-rouge">f</code> is what we call a “file handle.” That means that it only <em>points</em> to the data and provides ways to work with it. By itself, it does not read the whole dataset into memory. To see basic information about the file, we can use a few different methods.</p>

<p>For instance, the header of the file, which contains most of the metadata about the file:</p>

<div class="cell code_cell">
  <div class="input_area">
    <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">f</span><span class="o">.</span><span class="n">header</span>

</code></pre></div>    </div>
  </div>

</div>

<p>To actually read in the shapes from memory, you can use the following commands:</p>

<div class="cell code_cell">
  <div class="input_area">
    <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">f</span><span class="o">.</span><span class="n">by_row</span><span class="p">(</span><span class="mi">14</span><span class="p">)</span> <span class="c"># gets the 14th shape from the file</span>

</code></pre></div>    </div>
  </div>

</div>

<div class="cell code_cell">
  <div class="input_area">
    <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">all_polygons</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">()</span> <span class="c"># reads in all polygons from memory</span>

</code></pre></div>    </div>
  </div>

</div>

<div class="cell code_cell">
  <div class="input_area">
    <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">len</span><span class="p">(</span><span class="n">all_polygons</span><span class="p">)</span>

</code></pre></div>    </div>
  </div>

</div>

<p>So, all 254 polygons have been read in from file. These are stored in libpysal shape objects, which can be used by libpysal and can be converted to other Python shape objects.</p>

<p>They typically have a few methods. So, since we’ve read in polygonal data, we can get some properties about the polygons. Let’s just have a look at the first polygon:</p>

<div class="cell code_cell">
  <div class="input_area">
    <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">all_polygons</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">5</span><span class="p">]</span>

</code></pre></div>    </div>
  </div>

</div>

<div class="cell code_cell">
  <div class="input_area">
    <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">all_polygons</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">centroid</span> <span class="c">#the centroid of the first polygon</span>

</code></pre></div>    </div>
  </div>

</div>

<div class="cell code_cell">
  <div class="input_area">
    <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">all_polygons</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">area</span>

</code></pre></div>    </div>
  </div>

</div>

<div class="cell code_cell">
  <div class="input_area">
    <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">all_polygons</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">perimeter</span>

</code></pre></div>    </div>
  </div>

</div>

<p>While in the Jupyter Notebook, you can examine what properties an object has by using the tab key.</p>

<div class="cell code_cell">
  <div class="input_area">
    <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">polygon</span> <span class="o">=</span> <span class="n">all_polygons</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

</code></pre></div>    </div>
  </div>

</div>

<div class="cell code_cell">
  <div class="input_area">
    <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">polygon</span><span class="o">.</span> <span class="c">#press tab when the cursor is right after the dot</span>

</code></pre></div>    </div>
  </div>

</div>

<h3 id="working-with-data-tables">Working with Data Tables</h3>

<div class="cell code_cell">
  <div class="input_area">
    <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">dbf_path</span> <span class="o">=</span> <span class="s">"data/texas.dbf"</span>
<span class="k">print</span><span class="p">(</span><span class="n">dbf_path</span><span class="p">)</span>

</code></pre></div>    </div>
  </div>

</div>

<p>When you’re working with tables of data, like a <code class="highlighter-rouge">csv</code> or <code class="highlighter-rouge">dbf</code>, you can extract your data in the following way. Let’s open the dbf file we got the path for above.</p>

<div class="cell code_cell">
  <div class="input_area">
    <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">f</span> <span class="o">=</span> <span class="n">ps</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="nb">open</span><span class="p">(</span><span class="n">dbf_path</span><span class="p">)</span>

</code></pre></div>    </div>
  </div>

</div>

<p>Just like with the shapefile, we can examine the header of the dbf file.</p>

<div class="cell code_cell">
  <div class="input_area">
    <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">f</span><span class="o">.</span><span class="n">header</span>

</code></pre></div>    </div>
  </div>

</div>

<p>So, the header is a list containing the names of all of the fields we can read.
If we just wanted to grab the data of interest, <code class="highlighter-rouge">HR90</code>, we can use either <code class="highlighter-rouge">by_col</code> or <code class="highlighter-rouge">by_col_array</code>, depending on the format we want the resulting data in:</p>

<div class="cell code_cell">
  <div class="input_area">
    <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">HR90</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">by_col</span><span class="p">(</span><span class="s">'HR90'</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">HR90</span><span class="p">)</span><span class="o">.</span><span class="n">__name__</span><span class="p">,</span> <span class="n">HR90</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">5</span><span class="p">])</span>
<span class="n">HR90</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">by_col_array</span><span class="p">(</span><span class="s">'HR90'</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">HR90</span><span class="p">)</span><span class="o">.</span><span class="n">__name__</span><span class="p">,</span> <span class="n">HR90</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">5</span><span class="p">])</span>

</code></pre></div>    </div>
  </div>

</div>

<p>As you can see, the <code class="highlighter-rouge">by_col</code> function returns a list of data, with no shape. It can only return one column at a time:</p>

<div class="cell code_cell">
  <div class="input_area">
    <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">HRs</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">by_col</span><span class="p">(</span><span class="s">'HR90'</span><span class="p">,</span> <span class="s">'HR80'</span><span class="p">)</span>

</code></pre></div>    </div>
  </div>

</div>

<p>This error message is called a “traceback,” as you see in the top right, and it usually provides feedback on why the previous command did not execute correctly. Here, you see that one-too-many arguments was provided to <code class="highlighter-rouge">__call__</code>, which tells us we cannot pass as many arguments as we did to <code class="highlighter-rouge">by_col</code>.</p>

<p>If you want to read in many columns at once and store them to an array, use <code class="highlighter-rouge">by_col_array</code>:</p>

<div class="cell code_cell">
  <div class="input_area">
    <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">HRs</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">by_col_array</span><span class="p">(</span><span class="s">'HR90'</span><span class="p">,</span> <span class="s">'HR80'</span><span class="p">)</span>

</code></pre></div>    </div>
  </div>

</div>

<div class="cell code_cell">
  <div class="input_area">
    <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">HRs</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">10</span><span class="p">]</span>

</code></pre></div>    </div>
  </div>

</div>

<p>It is best to use <code class="highlighter-rouge">by_col_array</code> on data of a single type. That is, if you read in a lot of columns, some of them numbers and some of them strings, all columns will get converted to the same datatype:</p>

<div class="cell code_cell">
  <div class="input_area">
    <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">allcolumns</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">by_col_array</span><span class="p">([</span><span class="s">'NAME'</span><span class="p">,</span> <span class="s">'STATE_NAME'</span><span class="p">,</span> <span class="s">'HR90'</span><span class="p">,</span> <span class="s">'HR80'</span><span class="p">])</span>

</code></pre></div>    </div>
  </div>

</div>

<div class="cell code_cell">
  <div class="input_area">
    <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">allcolumns</span>

</code></pre></div>    </div>
  </div>

</div>

<p>Note that the numerical columns, <code class="highlighter-rouge">HR90</code> &amp; <code class="highlighter-rouge">HR80</code> are now considered strings, since they show up with the single tickmarks around them, like <code class="highlighter-rouge">'0.0'</code>.</p>

<p>These methods work similarly for <code class="highlighter-rouge">.csv</code> files as well.</p>

<h2 id="geopandas--pandas">Geopandas &amp; pandas</h2>

<div class="cell code_cell">
  <div class="input_area">
    <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">shp_path</span> <span class="o">=</span> <span class="n">ps</span><span class="o">.</span><span class="n">examples</span><span class="o">.</span><span class="n">get_path</span><span class="p">(</span><span class="s">'NAT.shp'</span><span class="p">)</span>
<span class="n">data_table</span> <span class="o">=</span> <span class="n">gpd</span><span class="o">.</span><span class="n">read_file</span><span class="p">(</span><span class="n">shp_path</span><span class="p">)</span>

</code></pre></div>    </div>
  </div>

</div>

<p>This reads in <em>the entire database table</em> and adds a column to the end, called <code class="highlighter-rouge">geometry</code>, that stores the geometries read in from the shapefile.</p>

<div class="cell code_cell">
  <div class="input_area">
    <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">data_table</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>

</code></pre></div>    </div>
  </div>

</div>

<p>The <code class="highlighter-rouge">read_file</code> function only works on shapefile/dbf pairs. If you need to read in data using CSVs, use pandas directly:</p>

<div class="cell code_cell">
  <div class="input_area">
    <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">csv_path</span> <span class="o">=</span> <span class="n">ps</span><span class="o">.</span><span class="n">examples</span><span class="o">.</span><span class="n">get_path</span><span class="p">(</span><span class="s">'usjoin.csv'</span><span class="p">)</span>
<span class="n">usjoin</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">csv_path</span><span class="p">)</span>
<span class="c">#usjoin = ps.pdio.read_files(csv_path) #will not work, not a shp/dbf pair</span>

</code></pre></div>    </div>
  </div>

</div>

<div class="cell code_cell">
  <div class="input_area">
    <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">gpd</span><span class="o">.</span><span class="n">read_file</span><span class="p">(</span><span class="n">csv_path</span><span class="p">)</span>

</code></pre></div>    </div>
  </div>

</div>

<div class="cell code_cell">
  <div class="input_area">
    <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">usjoin</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>

</code></pre></div>    </div>
  </div>

</div>

<p>The nice thing about working with geopandas dataframes is that they have very powerful baked-in support for relational-style queries. By this, I mean that it is very easy to find things like:</p>

<p>The number of counties in each state:</p>

<div class="cell code_cell">
  <div class="input_area">
    <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">data_table</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s">"STATE_NAME"</span><span class="p">)</span><span class="o">.</span><span class="n">size</span><span class="p">()</span>

</code></pre></div>    </div>
  </div>

</div>

<p>Or, to get the rows of the table that are in Arizona, we can use the <code class="highlighter-rouge">query</code> function of the dataframe:</p>

<div class="cell code_cell">
  <div class="input_area">
    <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">data_table</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="s">'STATE_NAME == "Arizona"'</span><span class="p">)</span>

</code></pre></div>    </div>
  </div>

</div>

<p>Behind the scenes, this uses a fast vectorized library, <code class="highlighter-rouge">numexpr</code>, to essentially do the following.</p>

<p>First, compare each row’s <code class="highlighter-rouge">STATE_NAME</code> column to <code class="highlighter-rouge">'Arizona'</code> and return <code class="highlighter-rouge">True</code> if the row matches:</p>

<div class="cell code_cell">
  <div class="input_area">
    <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">data_table</span><span class="o">.</span><span class="n">STATE_NAME</span> <span class="o">==</span> <span class="s">'Arizona'</span>

</code></pre></div>    </div>
  </div>

</div>

<p>Then, use that to filter out rows where the condition is true:</p>

<div class="cell code_cell">
  <div class="input_area">
    <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">data_table</span><span class="p">[</span><span class="n">data_table</span><span class="o">.</span><span class="n">STATE_NAME</span> <span class="o">==</span> <span class="s">'Arizona'</span><span class="p">]</span>

</code></pre></div>    </div>
  </div>

</div>

<p>We might need this behind the scenes knowledge when we want to chain together conditions, or when we need to do spatial queries.</p>

<p>This is because spatial queries are somewhat more complex. Let’s say, for example, we want all of the counties in the US to the West of <code class="highlighter-rouge">-121</code> longitude. We need a way to express that question. Ideally, we want something like:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>SELECT
        *
FROM
        data_table
WHERE
        x_centroid &lt; -121
</code></pre></div></div>

<p>So, let’s refer to an arbitrary polygon in the the dataframe’s geometry column as <code class="highlighter-rouge">poly</code>. We can acquire the centroid of the polygon as a shapely Point. Then we can acquire the coordinates of the point. The longitude is the first element of the pair of the coordinates.</p>

<p>Then, applying this condition to each geometry, we get the same kind of filter we used above to grab only counties in Arizona:</p>

<div class="cell code_cell">
  <div class="input_area">
    <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">type</span><span class="p">(</span><span class="n">data_table</span><span class="o">.</span><span class="n">geometry</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">centroid</span><span class="p">)</span>

</code></pre></div>    </div>
  </div>

</div>

<div class="cell code_cell">
  <div class="input_area">
    <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">list</span><span class="p">(</span><span class="n">data_table</span><span class="o">.</span><span class="n">geometry</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">centroid</span><span class="o">.</span><span class="n">coords</span><span class="p">)</span>

</code></pre></div>    </div>
  </div>

</div>

<div class="cell code_cell">
  <div class="input_area">
    <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">data_table</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="nb">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">centroid</span><span class="o">.</span><span class="n">coords</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;</span> <span class="o">-</span><span class="mi">121</span><span class="p">)</span>\
                   <span class="o">.</span><span class="n">head</span><span class="p">()</span>

</code></pre></div>    </div>
  </div>

</div>

<p>If we use this as a filter on the table, we can get only the rows that match that condition, just like we did for the <code class="highlighter-rouge">STATE_NAME</code> query:</p>

<div class="cell code_cell">
  <div class="input_area">
    <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">data_table</span><span class="p">[</span><span class="n">data_table</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="nb">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">centroid</span><span class="o">.</span><span class="n">coords</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;</span> <span class="o">-</span><span class="mi">119</span><span class="p">)]</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>

</code></pre></div>    </div>
  </div>

</div>

<div class="cell code_cell">
  <div class="input_area">
    <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">len</span><span class="p">(</span><span class="n">data_table</span><span class="p">[</span><span class="n">data_table</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="nb">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">centroid</span><span class="o">.</span><span class="n">coords</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;</span> <span class="o">-</span><span class="mi">119</span><span class="p">)])</span> <span class="c">#how many west of -119?</span>

</code></pre></div>    </div>
  </div>

</div>

<h2 id="other-types-of-spatial-queries">Other types of spatial queries</h2>

<p>Everybody knows the following statements are true:</p>

<ol>
  <li>If you head directly west from Reno, Nevada, you will shortly enter California.</li>
  <li>San Diego is in California.</li>
</ol>

<p>But what does this tell us about the location of San Diego relative to Reno?</p>

<p>Or for that matter, how many counties in California are to the east of Reno?</p>

<div class="cell code_cell">
  <div class="input_area">
    <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">geom</span> <span class="o">=</span> <span class="n">data_table</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="s">'(NAME == "Washoe") &amp; (STATE_NAME == "Nevada")'</span><span class="p">)</span><span class="o">.</span><span class="n">geometry</span>

</code></pre></div>    </div>
  </div>

</div>

<div class="cell code_cell">
  <div class="input_area">
    <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">geom</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

</code></pre></div>    </div>
  </div>

</div>

<div class="cell code_cell">
  <div class="input_area">
    <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">geom</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">centroid</span>

</code></pre></div>    </div>
  </div>

</div>

<div class="cell code_cell">
  <div class="input_area">
    <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">lon</span><span class="p">,</span><span class="n">lat</span> <span class="o">=</span> <span class="n">geom</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">centroid</span><span class="o">.</span><span class="n">coords</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

</code></pre></div>    </div>
  </div>

</div>

<div class="cell code_cell">
  <div class="input_area">
    <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">lon</span>

</code></pre></div>    </div>
  </div>

</div>

<div class="cell code_cell">
  <div class="input_area">
    <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">cal_counties</span> <span class="o">=</span> <span class="n">data_table</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="s">'(STATE_NAME=="California")'</span><span class="p">)</span>

</code></pre></div>    </div>
  </div>

</div>

<div class="cell code_cell">
  <div class="input_area">
    <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">cal_counties</span><span class="p">[</span><span class="n">cal_counties</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="nb">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">centroid</span><span class="o">.</span><span class="n">coords</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">lon</span><span class="p">)]</span>

</code></pre></div>    </div>
  </div>

</div>

<div class="cell code_cell">
  <div class="input_area">
    <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">len</span><span class="p">(</span><span class="n">cal_counties</span><span class="p">)</span>

</code></pre></div>    </div>
  </div>

</div>

<p>This works on any type of spatial query.</p>

<p>For instance, if we wanted to find all of the counties that are within a threshold distance from an observation’s centroid, we can do it in the following way.</p>

<p>But first, we need to handle distance calculations on the earth’s surface.</p>

<div class="cell code_cell">
  <div class="input_area">
    <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="nn">math</span> <span class="kn">import</span> <span class="n">radians</span><span class="p">,</span> <span class="n">sin</span><span class="p">,</span> <span class="n">cos</span><span class="p">,</span> <span class="n">sqrt</span><span class="p">,</span> <span class="n">asin</span>

<span class="k">def</span> <span class="nf">gcd</span><span class="p">(</span><span class="n">loc1</span><span class="p">,</span> <span class="n">loc2</span><span class="p">,</span> <span class="n">R</span><span class="o">=</span><span class="mi">3961</span><span class="p">):</span>
    <span class="s">"""Great circle distance via Haversine formula
    
    Parameters
    ----------
    
    loc1: tuple (long, lat in decimal degrees)
    
    loc2: tuple (long, lat in decimal degrees)
    
    R: Radius of the earth (3961 miles, 6367 km)
    
    Returns
    -------
    great circle distance between loc1 and loc2 in units of R
    
    
    Notes
    ------
    Does not take into account non-spheroidal shape of the Earth
    
    
    
    &gt;&gt;&gt; san_diego = -117.1611, 32.7157
    &gt;&gt;&gt; austin = -97.7431, 30.2672
    &gt;&gt;&gt; gcd(san_diego, austin)
    1155.474644164695
  
    
    """</span>
    <span class="n">lon1</span><span class="p">,</span> <span class="n">lat1</span> <span class="o">=</span> <span class="n">loc1</span>
    <span class="n">lon2</span><span class="p">,</span> <span class="n">lat2</span> <span class="o">=</span> <span class="n">loc2</span>
    <span class="n">dLat</span> <span class="o">=</span> <span class="n">radians</span><span class="p">(</span><span class="n">lat2</span> <span class="o">-</span> <span class="n">lat1</span><span class="p">)</span>
    <span class="n">dLon</span> <span class="o">=</span> <span class="n">radians</span><span class="p">(</span><span class="n">lon2</span> <span class="o">-</span> <span class="n">lon1</span><span class="p">)</span>
    <span class="n">lat1</span> <span class="o">=</span> <span class="n">radians</span><span class="p">(</span><span class="n">lat1</span><span class="p">)</span>
    <span class="n">lat2</span> <span class="o">=</span> <span class="n">radians</span><span class="p">(</span><span class="n">lat2</span><span class="p">)</span>
 
    <span class="n">a</span> <span class="o">=</span> <span class="n">sin</span><span class="p">(</span><span class="n">dLat</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">cos</span><span class="p">(</span><span class="n">lat1</span><span class="p">)</span><span class="o">*</span><span class="n">cos</span><span class="p">(</span><span class="n">lat2</span><span class="p">)</span><span class="o">*</span><span class="n">sin</span><span class="p">(</span><span class="n">dLon</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span>
    <span class="n">c</span> <span class="o">=</span> <span class="mi">2</span><span class="o">*</span><span class="n">asin</span><span class="p">(</span><span class="n">sqrt</span><span class="p">(</span><span class="n">a</span><span class="p">))</span>

    <span class="k">return</span> <span class="n">R</span> <span class="o">*</span> <span class="n">c</span>
 
<span class="k">def</span> <span class="nf">gcdm</span><span class="p">(</span><span class="n">loc1</span><span class="p">,</span> <span class="n">loc2</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">gcd</span><span class="p">(</span><span class="n">loc1</span><span class="p">,</span> <span class="n">loc2</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">gcdk</span><span class="p">(</span><span class="n">loc1</span><span class="p">,</span> <span class="n">loc2</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">gcd</span><span class="p">(</span><span class="n">loc1</span><span class="p">,</span> <span class="n">loc2</span><span class="p">,</span> <span class="mi">6367</span> <span class="p">)</span>

</code></pre></div>    </div>
  </div>

</div>

<div class="cell code_cell">
  <div class="input_area">
    <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">san_diego</span> <span class="o">=</span> <span class="o">-</span><span class="mf">117.1611</span><span class="p">,</span> <span class="mf">32.7157</span>
<span class="n">austin</span> <span class="o">=</span> <span class="o">-</span><span class="mf">97.7431</span><span class="p">,</span> <span class="mf">30.2672</span>
<span class="n">gcd</span><span class="p">(</span><span class="n">san_diego</span><span class="p">,</span> <span class="n">austin</span><span class="p">)</span>

</code></pre></div>    </div>
  </div>

</div>

<div class="cell code_cell">
  <div class="input_area">
    <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">gcdk</span><span class="p">(</span><span class="n">san_diego</span><span class="p">,</span> <span class="n">austin</span><span class="p">)</span>

</code></pre></div>    </div>
  </div>

</div>

<div class="cell code_cell">
  <div class="input_area">
    <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">loc1</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="mf">117.1611</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">)</span>
<span class="n">loc2</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="mf">118.1611</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">)</span>
<span class="n">gcd</span><span class="p">(</span><span class="n">loc1</span><span class="p">,</span> <span class="n">loc2</span><span class="p">)</span>

</code></pre></div>    </div>
  </div>

</div>

<div class="cell code_cell">
  <div class="input_area">
    <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">loc1</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="mf">117.1611</span><span class="p">,</span> <span class="mf">45.0</span><span class="p">)</span>
<span class="n">loc2</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="mf">118.1611</span><span class="p">,</span> <span class="mf">45.0</span><span class="p">)</span>
<span class="n">gcd</span><span class="p">(</span><span class="n">loc1</span><span class="p">,</span> <span class="n">loc2</span><span class="p">)</span>

</code></pre></div>    </div>
  </div>

</div>

<div class="cell code_cell">
  <div class="input_area">
    <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">loc1</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="mf">117.1611</span><span class="p">,</span> <span class="mf">89.0</span><span class="p">)</span>
<span class="n">loc2</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="mf">118.1611</span><span class="p">,</span> <span class="mf">89.0</span><span class="p">)</span>
<span class="n">gcd</span><span class="p">(</span><span class="n">loc1</span><span class="p">,</span> <span class="n">loc2</span><span class="p">)</span>

</code></pre></div>    </div>
  </div>

</div>

<div class="cell code_cell">
  <div class="input_area">
    <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">lats</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">91</span><span class="p">)</span>
<span class="n">onedeglon</span> <span class="o">=</span> <span class="p">[</span> <span class="n">gcd</span><span class="p">((</span><span class="o">-</span><span class="mf">117.1611</span><span class="p">,</span><span class="n">lat</span><span class="p">),(</span><span class="o">-</span><span class="mf">118.1611</span><span class="p">,</span><span class="n">lat</span><span class="p">))</span> <span class="k">for</span> <span class="n">lat</span> <span class="ow">in</span> <span class="n">lats</span><span class="p">]</span>

</code></pre></div>    </div>
  </div>

</div>

<div class="cell code_cell">
  <div class="input_area">
    <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="n">plt</span>
<span class="o">%</span><span class="n">matplotlib</span> <span class="n">inline</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">lats</span><span class="p">,</span> <span class="n">onedeglon</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s">'miles'</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s">'degree of latitude'</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s">'Length of a degree of longitude'</span><span class="p">)</span>

</code></pre></div>    </div>
  </div>

</div>

<div class="cell code_cell">
  <div class="input_area">
    <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">san_diego</span> <span class="o">=</span> <span class="o">-</span><span class="mf">117.1611</span><span class="p">,</span> <span class="mf">32.7157</span>
<span class="n">austin</span> <span class="o">=</span> <span class="o">-</span><span class="mf">97.7431</span><span class="p">,</span> <span class="mf">30.2672</span>
<span class="n">gcd</span><span class="p">(</span><span class="n">san_diego</span><span class="p">,</span> <span class="n">austin</span><span class="p">)</span>

</code></pre></div>    </div>
  </div>

</div>

<p>Now we can use our distance function to pose distance-related queries on our data table.</p>

<div class="cell code_cell">
  <div class="input_area">
    <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># Find all the counties with centroids within 50 miles of Austin</span>
<span class="k">def</span> <span class="nf">near_target_point</span><span class="p">(</span><span class="n">polygon</span><span class="p">,</span> <span class="n">target</span><span class="o">=</span><span class="n">austin</span><span class="p">,</span> <span class="n">threshold</span><span class="o">=</span><span class="mi">50</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">gcd</span><span class="p">(</span><span class="n">polygon</span><span class="o">.</span><span class="n">centroid</span><span class="o">.</span><span class="n">coords</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">target</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">threshold</span> 

<span class="n">data_table</span><span class="p">[</span><span class="n">data_table</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="nb">apply</span><span class="p">(</span><span class="n">near_target_point</span><span class="p">)]</span>

</code></pre></div>    </div>
  </div>

</div>

<h3 id="moving-in-and-out-of-the-dataframe">Moving in and out of the dataframe</h3>

<p>Most things in PySAL will be explicit about what type their input should be. Most of the time, PySAL functions require either lists or arrays. This is why the file-handler methods are the default IO method in PySAL: the rest of the computational tools are built around their datatypes.</p>

<p>However, it is very easy to get the correct datatype from Pandas or Geopandas using the <code class="highlighter-rouge">values</code> and <code class="highlighter-rouge">tolist</code> commands.</p>

<p><code class="highlighter-rouge">tolist()</code> will convert its entries to a list. But, it can only be called on individual columns (called <code class="highlighter-rouge">Series</code> in <code class="highlighter-rouge">pandas</code> documentation).</p>

<p>So, to turn the <code class="highlighter-rouge">NAME</code> column into a list:</p>

<div class="cell code_cell">
  <div class="input_area">
    <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">data_table</span><span class="o">.</span><span class="n">NAME</span><span class="o">.</span><span class="n">tolist</span><span class="p">()[</span><span class="mi">0</span><span class="p">:</span><span class="mi">10</span><span class="p">]</span>

</code></pre></div>    </div>
  </div>

</div>

<p>To extract many columns, you must select the columns you want and call their <code class="highlighter-rouge">.values</code> attribute.</p>

<p>If we were interested in grabbing all of the <code class="highlighter-rouge">HR</code> variables in the dataframe, we could first select those column names:</p>

<div class="cell code_cell">
  <div class="input_area">
    <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">HRs</span> <span class="o">=</span> <span class="p">[</span><span class="n">col</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">data_table</span><span class="o">.</span><span class="n">columns</span> <span class="k">if</span> <span class="n">col</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s">'HR'</span><span class="p">)]</span>
<span class="n">HRs</span>

</code></pre></div>    </div>
  </div>

</div>

<p>We can use this to focus only on the columns we want:</p>

<div class="cell code_cell">
  <div class="input_area">
    <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">data_table</span><span class="p">[</span><span class="n">HRs</span><span class="p">]</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>

</code></pre></div>    </div>
  </div>

</div>

<p>With this, calling <code class="highlighter-rouge">.values</code> gives an array containing all of the entries in this subset of the table:</p>

<div class="cell code_cell">
  <div class="input_area">
    <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">data_table</span><span class="p">[[</span><span class="s">'HR90'</span><span class="p">,</span> <span class="s">'HR80'</span><span class="p">]]</span><span class="o">.</span><span class="n">values</span>

</code></pre></div>    </div>
  </div>

</div>

<h2 id="exercises">Exercises</h2>

<ol>
  <li>Find the county with the western most centroid that is within 1000 miles of Austin.</li>
  <li>Find the distance between Austin and that centroid.</li>
</ol>

<h2 id="solutions">Solutions</h2>

<div class="cell code_cell">
  <div class="input_area">
    <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">austin_lon</span> <span class="o">=</span> <span class="n">austin</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="n">west</span> <span class="o">=</span> <span class="n">data_table</span><span class="p">[</span><span class="n">data_table</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="nb">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">centroid</span><span class="o">.</span><span class="n">coords</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">austin_lon</span><span class="p">)]</span>


</code></pre></div>    </div>
  </div>

</div>

<div class="cell code_cell">
  <div class="input_area">
    <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">near_target_point</span><span class="p">(</span><span class="n">polygon</span><span class="p">,</span> <span class="n">target</span><span class="o">=</span><span class="n">austin</span><span class="p">,</span> <span class="n">threshold</span><span class="o">=</span><span class="mi">1000</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">gcd</span><span class="p">(</span><span class="n">polygon</span><span class="o">.</span><span class="n">centroid</span><span class="o">.</span><span class="n">coords</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">target</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="n">threshold</span> 

<span class="n">west_lt_1000</span> <span class="o">=</span> <span class="n">west</span><span class="p">[</span><span class="n">west</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="nb">apply</span><span class="p">(</span><span class="n">near_target_point</span><span class="p">)]</span>

</code></pre></div>    </div>
  </div>

</div>

<div class="cell code_cell">
  <div class="input_area">
    <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">maxd</span> <span class="o">=</span> <span class="mf">0.</span>
<span class="n">county</span> <span class="o">=</span> <span class="bp">None</span>
<span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">row</span> <span class="ow">in</span> <span class="n">west_lt_1000</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
    <span class="n">d</span> <span class="o">=</span> <span class="n">gcd</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="s">'geometry'</span><span class="p">]</span><span class="o">.</span><span class="n">centroid</span><span class="o">.</span><span class="n">coords</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">austin</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">d</span> <span class="o">&gt;</span> <span class="n">maxd</span><span class="p">:</span>
        <span class="n">county</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="s">'NAME'</span><span class="p">]</span>
        <span class="n">state</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="s">'STATE_NAME'</span><span class="p">]</span>
        <span class="n">maxd</span> <span class="o">=</span> <span class="n">d</span>

<span class="k">print</span><span class="p">(</span><span class="s">'Centroid of </span><span class="si">%</span><span class="s">s, </span><span class="si">%</span><span class="s">s is </span><span class="si">%</span><span class="s">f miles west of Austin'</span><span class="o">%</span><span class="p">(</span><span class="n">county</span><span class="p">,</span> <span class="n">state</span><span class="p">,</span> <span class="n">maxd</span><span class="p">))</span>

</code></pre></div>    </div>
  </div>

</div>


              <nav class="c-page__nav">
  
    
    <a id="js-page__nav__prev" class="c-page__nav__prev" href="/processing/intro">
      〈 <span class="u-margin-right-tiny"></span> Geoprocessing and Visualization
    </a>
  

  
    
    <a id="js-page__nav__next" class="c-page__nav__next" href="/processing/08_routes">
      Geoprocessing Exercise <span class="u-margin-right-tiny"></span> 〉
    </a>
  
</nav>

            </div>
          </div>
        </div>
      </main>
    </div>

  </body>
</html>
